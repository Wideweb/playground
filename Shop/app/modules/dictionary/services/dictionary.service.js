/**********************************************************************************************
 * Dictionary Model
**********************************************************************************************/
class Model {

    /******************************************************************************************
     Initialization
     ******************************************************************************************/
    constructor(
        /* Object */ data
    ) {
        this.id = data.id;
        this.term = data.term;
        this.image = data.image;
        this.translation = data.translation;
    }

    /******************************************************************************************
     * serialization
     ******************************************************************************************/
    serialize() {
        return {
            id: this.id,
            term: this.term,
            translation: this.translation
        }
    }
}

/**********************************************************************************************
 * Controller
 **********************************************************************************************/
const Controller = {
    list: [],
    map: {},

    /******************************************************************************************
     * METHODS
     ******************************************************************************************
     * registration of a new instance
     ******************************************************************************************/
    register: (list = []) => {
        list.forEach(data => {
            let item = new Model(data);

            if (!Controller.map[item.id]) {
                Controller.list.push(item);
            }

            Controller.map[item.id] = item;
        });

        return Controller.list;
    },

    /******************************************************************************************
     Clean up registered instances
     ******************************************************************************************/
    clear: () => {
        Controller.list = [];
        Controller.map = {};
    },

    /******************************************************************************************
     Set an instance to be current (by ID) -> or nothing
     ******************************************************************************************/
    setCurrent: (
        /* String? */ id
    ) => {
        Controller.current = Controller.map[id];
        return Controller.current;
    },

};

/**********************************************************************************************
 * Access Provider
 **********************************************************************************************/
export default class {
    static get $inject() {
        return [
            'httpProxyService',
        ];
    }

    /******************************************************************************************
     * Initialization
     ******************************************************************************************/
    constructor(
        proxy
    ) {
        this.proxy = proxy;
    }

    /******************************************************************************************
     References to private resources
     ******************************************************************************************
     * registered instances reference
     ******************************************************************************************/
    get list() {
        return Controller.list;
    }

    /******************************************************************************************
     * registered instances reference
     ******************************************************************************************/
    get map() {
        return Controller.map;
    }

    /******************************************************************************************
     * registered instances reference
     ******************************************************************************************/
    get current() {
        return Controller.current;
    }

    /******************************************************************************************
     Public Methods
     ******************************************************************************************
     Load user dictionary
     ******************************************************************************************/
    load() {
        return this.proxy
            .call('GetDictionary')
            .then((data) => {
                Controller.clear();
                Controller.register(data);
            });
    }

    /******************************************************************************************
     Load dictionary item
     ******************************************************************************************/
    loadItem(
        /* number */ id
    ) {
        return this.proxy
            .call('GetDictionaryItem', { id })
            .then((data) => {
                Controller.register([data]);
                Controller.setCurrent(id);
            });
    }

    /******************************************************************************************
     * Save dictionary term
     ******************************************************************************************/
    save(
        /* string */ term,
        /* string */ translation,
        /* base64*/ image
    ) {
        return this.proxy
            .call('SaveDictionaryItem', {}, { term, translation, image })
            .then(() => this.load());
    }

    /******************************************************************************************
     * Remove dictionary term
     ******************************************************************************************/
    remove(
        /* int */ id
    ) {
        return this.proxy
            .call('RemoveDictionaryItem', { id })
            .then(() => this.load());
    }
}